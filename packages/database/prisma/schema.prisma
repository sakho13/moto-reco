generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Models

model MAuthProvider {
  id String @id @default(cuid(2))

  userId       String       @map("user_id")
  providerType ProviderType @map("provider_type")
  externalId   String       @map("external_id")
  metadata     Json?

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user MUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerType, externalId])
  @@index([userId, isActive])
}

model MUser {
  id   String @id @default(cuid(2))
  name String

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  status MUserStatus @default(ACTIVE) @map("status")
  role   MUserRole   @default(USER) @map("role")

  authProviders MAuthProvider[]
  myBikes       TUserMyBike[]
}

model MManufacturer {
  id         String  @id @default(cuid(2))
  name       String  @unique @map("name") // メーカー名（日本語）
  nameEn     String? @map("name_en") // 英語名
  logoUrl    String? @map("logo_url") // ロゴURL
  websiteUrl String? @map("website_url") // 公式サイト
  country    String? @map("country") // 国
  isActive   Boolean @default(true) @map("is_active") // アクティブフラグ

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  bikes MBike[]
}

model MBike {
  id             String @id @default(cuid(2))
  manufacturerId String @map("manufacturer_id")
  modelName      String @map("model_name") // メーカー名を除いたモデル名（例: "CB400SF"）
  displacement   Float // 排気量/cc
  modelYear      Int    @map("model_year")

  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")
  settingStatus BikeStatus @default(INACTIVE) @map("setting_status") // 設定状態

  manufacturer         MManufacturer      @relation(fields: [manufacturerId], references: [id], onDelete: Restrict)
  bikeMaintenanceTypes MMaintenanceType[]
  userBikes            TUserBike[]

  @@index([manufacturerId])
  @@index([modelName, modelYear])
}

model MMaintenanceType {
  id String @id @default(cuid(2))

  bikeId String          @map("bike_id")
  type   MaintenanceType

  recommendedMileage Int @map("recommended_mileage") // 推奨走行距離/km
  recommendedPeriod  Int @map("recommended_period") // 推奨期間/月

  bike MBike @relation(fields: [bikeId], references: [id], onDelete: Restrict)

  @@unique([bikeId, type])
}

model TUserBike {
  id           String @id @default(cuid(2))
  bikeId       String @map("bike_id")
  serialNumber String @unique @map("serial_number")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  bike    MBike         @relation(fields: [bikeId], references: [id], onDelete: Restrict)
  myBikes TUserMyBike[]
}

model TUserMyBike {
  id         String @id @default(cuid(2))
  userId     String @map("user_id")
  userBikeId String @map("user_bike_id")

  // ユーザー独自の設定
  nickname        String?   @map("nickname") // 愛称
  purchaseDate    DateTime? @map("purchase_date")
  purchasePrice   Int?      @map("purchase_price")
  purchaseMileage Int?      @map("purchase_mileage")
  totalMileage    Int       @default(0) @map("total_mileage") // 総走行距離/km

  // 所有状態
  ownedAt   DateTime          @map("owned_at")
  soldAt    DateTime?         @map("sold_at")
  ownStatus UserBikeOwnStatus @default(OWN) @map("own_status")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user     MUser     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userBike TUserBike @relation(fields: [userBikeId], references: [id], onDelete: Restrict)

  fuelLogs TUserMyBikeFuelLog[]

  @@index([userId, ownStatus])
  @@index([ownedAt])
}

model TUserMyBikeFuelLog {
  id           String @id @default(cuid(2))
  userMyBikeId String @map("my_bike_id")

  amount     Float    @map("amount") // 給油量/L
  price      Int      @map("price") // 給油価格/円
  mileage    Int      @map("mileage") // 給油時総走行距離/km
  refueledAt DateTime @map("refueled_at") // 給油日時

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  userMyBike TUserMyBike @relation(fields: [userMyBikeId], references: [id], onDelete: Cascade)

  @@index([userMyBikeId, refueledAt])
}

// Enums

enum MUserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum MUserRole {
  USER
  ADMIN
}

enum ProviderType {
  FIREBASE_EMAIL
  FIREBASE_GOOGLE
}

enum BikeStatus {
  INACTIVE
  ACTIVE
}

enum MaintenanceType {
  // ブレーキ装置
  BRAKE_FLUID
  FRONT_BRAKE_PAD
  REAR_BRAKE_PAD
  MASTER_CYLINDER_CUP
  BRAKE_CALIPER_SEAL
  BRAKE_CABLE

  // エンジン
  SPARK_PLUG
  COOLANT
  ENGINE_OIL
  OIL_CLEANER

  // 動力伝達装置
  TRANSMISSION_OIL
  DRIVE_CHAIN
  DRIVE_BELT

  // タイヤ
  FRONT_TIRE
  REAR_TIRE

  // 電気装置
  BATTERY
  LIGHT
  TURN_SIGNAL
  HORN
}

enum UserBikeOwnStatus {
  OWN // 所有中
  SOLD // 売却済み
  TRANSFERRED // 譲渡済み
  SCRAPPED // 廃車
}
